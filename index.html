<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Saint Thomas Attendance</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Comic Sans MS", sans-serif;
  background-color: #f5f5f7;
  color: #1c1c1e;
  margin: 0;
  padding: 20px;
}

h1, h3 {
  font-weight: 600;
  margin-bottom: 10px;
  text-align: left;
}

h2 {
  font-weight: 300;
  margin-bottom: 10px;
  text-align: left;
}

input, button, textarea {
  font-family: inherit;
  border-radius: 12px;
  border: 1px solid #d1d1d6;
  padding: 10px;
  margin: 5px 0;
  outline: none;
}

button {
  background-color: #007aff;
  color: white;
  border: none;
  cursor: pointer;
  transition: background 0.2s;
}

button:hover { background-color: #0051a8; }

.autocomplete-box {
  position: relative;
  width: 100%;
}

.suggestions {
  position: absolute;
  background: white;
  border: 1px solid #ccc;
  border-radius: 10px;
  width: 100%;
  max-height: 180px;
  overflow-y: auto;
  z-index: 20;
}

.suggestion-item {
  padding: 8px 12px;
  cursor: pointer;
}

.suggestion-item:hover,
.suggestion-item.active {
  background-color: #e5e5ea;
}

.selected-list {
  margin-top: 10px;
  padding: 10px;
  background: white;
  border-radius: 12px;
  border: 1px solid #d1d1d6;
}

.selected-pill {
  background: #007aff;
  color: white;
  padding: 6px 12px;
  border-radius: 20px;
  margin: 4px;
  font-size: 14px;
  display: inline-block;
}

.selected-pill span {
  margin-left: 8px;
  cursor: pointer;
  font-weight: bold;
}

.note-box {
  display: block;
  margin-top: 5px;
  margin-bottom: 10px;
  width: 100%;
  border-radius: 8px;
  padding: 6px;
  border: 1px solid #ccc;
}

.table {
  background-color: white;
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
  padding: 15px;
  width: 100%;
  box-sizing: border-box;
}

#output {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 15px;
  margin-top: 15px;
}

li {
  list-style: none;
  padding: 6px;
  margin: 4px 0;
  background: #f0f0f5;
  border-radius: 6px;
  cursor: grab;
}

li:active {
  cursor: grabbing;
}

.footer-text {
  margin-top: 40px;
  font-size: 12px;
  color: #6e6e73;
  text-align: center;
}

/* Mode buttons */
.mode-buttons {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}

.mode-button {
  flex: 1;
  padding: 10px;
  border-radius: 999px;
  border: 1px solid #d1d1d6;
  background-color: #e5e5ea;
  color: #1c1c1e;
  font-weight: 600;
}

.mode-button.active-mode {
  background-color: #007aff;
  color: white;
  border-color: #007aff;
}

.hidden {
  display: none !important;
}
</style>
</head>

<body>

<h1>Saint Thomas Youth Group Attendance and Table Sorter</h1>

<h2>By Raph</h2>

<!-- MODE SELECTOR -->
<div class="mode-buttons">
  <button id="rosaryModeBtn" class="mode-button" onclick="setMode('rosary')">Rosary Attendance</button>
  <button id="youthModeBtn" class="mode-button active-mode" onclick="setMode('youth')">Youth Group Attendance</button>
</div>

<!-- PRESENT ATTENDEES (SHARED BY BOTH MODES) -->
<h3>Present Attendees</h3>
<div class="autocomplete-box">
  <input id="presentInput" type="text" placeholder="Type a name..." autocomplete="off">
  <div id="presentSuggestions" class="suggestions"></div>
</div>
<div id="presentSelected" class="selected-list"></div>

<!-- YOUTH GROUP ONLY FEATURES WRAPPED HERE -->
<div id="youthFeatures">
  <!-- CORE MEMBERS -->
  <h3>Core Members</h3>
  <div class="autocomplete-box">
    <input id="coreInput" type="text" placeholder="Type a core member..." autocomplete="off">
    <div id="coreSuggestions" class="suggestions"></div>
  </div>
  <div id="coreSelected" class="selected-list"></div>

  <h3>Groups That Must Sit Together (comma separated per line)</h3>
  <textarea id="togetherGroups"></textarea>

  <h3>Number of Tables</h3>
  <input type="number" id="numTables" min="1" value="8" />

  <br>
  <button onclick="generateTables()">Generate Tables</button>

  <div id="output"></div>
</div>

<h3>Attendance List (Copy and paste from here!)</h3>
<textarea id="copyList" style="
  width: 100%;
  height: 180px;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid #ccc;
  font-size: 16px;
  resize: vertical;
"></textarea>



<!-- EXPORT BUTTON (AVAILABLE IN BOTH MODES) -->
<button onclick="exportToCSV()" id="exportButton" style="background:#28a745; margin-top:10px;">Export Present People to CSV</button>

<div class="footer-text">
  &copy; 2026 Saint Thomas the Apostle Youth Group by Raphael Ide. All rights reserved.
</div>

<script>
const allAttendees = [
  'Mara Wesolowski','Allie Choate','Bria Santoro','MariaTeresa Arena',
  'Danny Kuyrouz','Amelia Cannato','Carmine Arena','Frencesco Arena',
  'Winnie McLaughlin','Caroline Lally','Luke Walsh','Flynn Walsh','James Bowman',
  'Emmie Valenzuela','Antony Marcucci','Maggie Woodard','Amelia Choate',
  'Andrew Foraker','Bella Calvo','Ben Biggins','Blake Masso','Will OBrien',
  'Bridget Gonya','Caroline Gonya','Bowman Rhinesmith','Cat Choate','Catalina Calvo',
  'Catarina Franchi','Catherine McLaughlin','Cecelia Lateo','Charbel Almacari',
  'Charlotte Keefe','Christine Cheely','Sammy Biggins','Clare Walsh','Cormac Doyle',
  'Dermot O\'Boyle','Dottie Mahoney','Elizabeth Brown','Ella Hill',
  'Emilia Parrella','','Emily Rameaka','Grace Ahearn','Grace Finnegan',
  'Grace Garvey','Grace Lynch','Graham Evans','Nicholas Arico','Grace Nohrden','Griffin Masso',
  'Hannah Keefe','Meghan Gonya','Joeseph Cumming','Illai Gutierrez','Immanuel Marmol',
  'James Golden','James Marcucci','James Walsh','Jenna Gorman','JJ Bachiochi',
  'John Enriquez','John Norhden','Nathan Behrmann','John Sullivan','Joseph Brennan','JP Golden',
  'Julianna Gutierrez','Kate Worcester','Keira Parrella','Libby Hamel',
  'Lily Nohrden','Livina Vaz','Luke Bachiochi','Michael Gonya','Maeve Walsh',
  'Maggie Arico','Mairead Flynn','Abby Biggins','Marae McCarthy','Maria McQuade',
  'MaryRose Mahoney','Matthew Brennan','Mia Driscoll','Mia Fiala','Michael Kenney',
  'Michelle Ide','Mitch Finnegan','Nathan Behrmann','Nico Reardon','Noah Crowder',
  'Noelle Watt','Nora Konetzny','Owen Gonet','Paul Haggarty','Penny Awad',
  'Peter Keefe','Reese Masso','Sophia Nicholson','Stella Driscoll','Ted Worcester',
  'Thomas Cleary','Tim Hill','Timmy Brown','Tom Marcucci','Tommy Biggins',
  'Tommy Hamel','Will Enriquez','Will Finnegan','Will Vaccaro','Winnie Subber',
  'Wyatt Subber','Xavier Bogart','Raphael Ide','Gigi Arico','Maria Elena Franchi','Natalia McLaughlin',
  'Cece McLaughlin','Genevieve Nohrden','Catalina Perdomo','Bella Gonet',
  'Ali Hamel','Ella Cronin','Alina Falcao','Paxton Roper'
];

const defaultCore = [
  "Raphael Ide","Gigi Arico","Maria Elena Franchi","Natalia McLaughlin",
  "Cece McLaughlin","Genevieve Nohrden","Catalina Perdomo","Bella Gonet",
  "Ali Hamel","Ella Cronin","Alina Falcao","Paxton Roper"
];

let presentList = [];  // objects: { name, notes }
let coreList = [];
let tables = [];       // global for drag/drop
let currentMode = 'youth'; // default

function setupAutocomplete(inputId, suggestionsId, selectedId, sourceList, targetArray, isPresent=false) {
  const input = document.getElementById(inputId);
  const suggestions = document.getElementById(suggestionsId);
  const selected = document.getElementById(selectedId);

  let activeIndex = -1;

  function renderSuggestions() {
    const query = input.value.toLowerCase();
    suggestions.innerHTML = "";

    if (!query) return;

    const matches = sourceList.filter(
      name => name.toLowerCase().includes(query) &&
      !targetArray.some(obj => obj.name === name || obj === name)
    );

    matches.forEach((name, index) => {
      const div = document.createElement("div");
      div.className = "suggestion-item";
      div.textContent = name;

      div.onclick = () => selectName(name);

      if (index === activeIndex) div.classList.add("active");

      suggestions.appendChild(div);
    });
  }

  function renderSelected() {
    selected.innerHTML = "";
    targetArray.forEach(obj => {
      const name = typeof obj === "string" ? obj : obj.name;

      const pill = document.createElement("div");
      pill.className = "selected-pill";
      pill.innerHTML = `${name} <span onclick="removeName('${name}', '${selectedId}')">Ã—</span>`;
      selected.appendChild(pill);

      if (isPresent) {
        const note = document.createElement("textarea");
        note.className = "note-box";
        note.placeholder = "Notes...";
        note.value = obj.notes || "";
        note.oninput = () => obj.notes = note.value;
        selected.appendChild(note);
      }
    });
  updateCopyList();
  }

  function selectName(name) {
    if (isPresent) {
      targetArray.push({ name, notes: "" });
    } 
    else {
      targetArray.push(name);
    }
    input.value = "";
    activeIndex = -1;
    renderSelected();
    updateCopyList();
    suggestions.innerHTML = "";
    input.focus();
  }

  input.addEventListener("input", renderSuggestions);

  input.addEventListener("keydown", e => {
    const items = suggestions.querySelectorAll(".suggestion-item");

    if (e.key === "ArrowDown") {
      activeIndex = (activeIndex + 1) % items.length;
      renderSuggestions();
    } else if (e.key === "ArrowUp") {
      activeIndex = (activeIndex - 1 + items.length) % items.length;
      renderSuggestions();
    } else if (e.key === "Enter") {
      e.preventDefault();

      if (items[activeIndex]) {
        selectName(items[activeIndex].textContent);
        return;
      }

      const typed = input.value.trim();
      if (typed && !sourceList.includes(typed)) {
        const confirmAdd = confirm(`"${typed}" is not in the list. Add permanently?`);
        if (confirmAdd) {
          sourceList.push(typed);
          selectName(typed);
        }
      }
    }
  });

  return renderSelected;
}

function updateCopyList() {
  let names = [];

  presentList.forEach(p => {
    if (coreList.includes(p.name)) {
      names.push(p.name + " (CORE)");
    } else {
      names.push(p.name);
    }
  });

  coreList.forEach(c => {
    if (!presentList.some(p => p.name === c)) {
      names.push(c + " (CORE)");
    }
  });

  document.getElementById("copyList").value = names.join("\n");
}

function removeName(name, selectedId) {
  if (selectedId === "presentSelected") {
    presentList = presentList.filter(obj => obj.name !== name);
    renderPresent();
    updateCopyList();
  } else {
    coreList = coreList.filter(n => n !== name);
    renderCore();
    updateCopyList();
  }
}

const renderPresent = setupAutocomplete(
  "presentInput", "presentSuggestions", "presentSelected",
  allAttendees, presentList, true
);

const renderCore = setupAutocomplete(
  "coreInput", "coreSuggestions", "coreSelected",
  defaultCore, coreList
);

function exportToCSV() {
  if (presentList.length === 0) {
    alert("No attendees selected.");
    return;
  }

  // Add core members who are also present
  let corePresent = coreList
    .filter(name => presentList.some(p => p.name === name))
    .map(name => ({ name, notes: "CORE MEMBER" }));

  let combined = [...presentList, ...corePresent];

  let csv = "data:text/csv;charset=utf-8,Name,Notes\n";
  combined.forEach(obj => {
    csv += `"${obj.name}","${obj.notes || ""}"\n`;
  });

  const link = document.createElement("a");
  link.href = encodeURI(csv);
  link.download = "youth_group_attendees.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function generateTables() {
  const num = parseInt(document.getElementById("numTables").value);
  const togetherInput = document.getElementById("togetherGroups").value
    .split(/\n+/).filter(x => x.trim());

  if (coreList.length < num) {
    alert("You need at least as many core members as tables.");
    return;
  }

  tables = Array.from({ length: num }, () => []);

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  const shuffledCore = shuffle([...coreList]);
  for (let i = 0; i < num; i++) tables[i].push(shuffledCore[i]);

  let remaining = presentList
    .map(obj => obj.name)
    .filter(x => !coreList.includes(x));

  let togetherGroups = togetherInput.map(line =>
    line.split(",").map(p => p.trim())
  );

  for (const group of togetherGroups) {
    const presentGroup = group.filter(p =>
      presentList.some(obj => obj.name === p)
    );

    if (presentGroup.length === 0) continue;

    const coreInGroup = presentGroup.filter(p => coreList.includes(p));

    if (coreInGroup.length > 0) {
      const anchor = coreInGroup[0];

      let tableIndex = tables.findIndex(t => t.includes(anchor));

      presentGroup.forEach(p => {
        if (!tables[tableIndex].includes(p)) tables[tableIndex].push(p);
      });

      remaining = remaining.filter(p => !presentGroup.includes(p));
    } else {
      let tableIndex = tables.reduce(
        (min, t, idx, arr) => t.length < arr[min].length ? idx : min, 0
      );

      tables[tableIndex].push(...presentGroup);
      remaining = remaining.filter(p => !presentGroup.includes(p));
    }
  }

  remaining = shuffle(remaining);
  let t = 0;
  for (const person of remaining) {
    tables[t].push(person);
    t = (t + 1) % num;
  }

  renderTables();
}

function renderTables() {
  const out = document.getElementById("output");
  out.innerHTML = "";

  tables.forEach((tbl, i) => {
    const div = document.createElement("div");
    div.className = "table";

    let html = `<h3>Table ${i + 1}</h3><ul ondragover="allowDrop(event)" ondrop="drop(event, ${i})">`;

    tbl.forEach(p => {
      html += `<li draggable="true" ondragstart="drag(event)" data-name="${p}">${p}</li>`;
    });

    html += "</ul>";
    div.innerHTML = html;
    out.appendChild(div);
  });
}

function drag(ev) {
  ev.dataTransfer.setData("text", ev.target.dataset.name);
}

function allowDrop(ev) {
  ev.preventDefault();
}

function drop(ev, tableIndex) {
  ev.preventDefault();
  const name = ev.dataTransfer.getData("text");

  tables.forEach(t => {
    const idx = t.indexOf(name);
    if (idx !== -1) t.splice(idx, 1);
  });

  tables[tableIndex].push(name);

  renderTables();
}

/* MODE SWITCHING */
function setMode(mode) {
  currentMode = mode;

  const youthFeatures = document.getElementById("youthFeatures");
  const rosaryBtn = document.getElementById("rosaryModeBtn");
  const youthBtn = document.getElementById("youthModeBtn");

  if (mode === 'rosary') {
    youthFeatures.classList.add("hidden");
    rosaryBtn.classList.add("active-mode");
    youthBtn.classList.remove("active-mode");
  } else {
    youthFeatures.classList.remove("hidden");
    youthBtn.classList.add("active-mode");
    rosaryBtn.classList.remove("active-mode");
  }
}
setMode('youth');
</script>

</body>
</html>
