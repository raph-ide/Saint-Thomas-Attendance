<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Saint Thomas Attendance</title>

<style>
/* =========================
   GLOBAL
========================= */
* { box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: radial-gradient(circle at top, rgba(122, 180, 255, 0.25), transparent 55%),
    linear-gradient(#f5f5f7, #ffffff);
  color: #1c1c1e;
  margin: 0;
  padding: 24px;
  max-width: 1100px;
  margin-inline: auto;
  line-height: 1.5;
}

/* =========================
   TYPOGRAPHY
========================= */
h1 {
  font-size: 32px;
  font-weight: 700;
  margin-bottom: 8px;
}

h1 span {
  display: block;
  font-size: 14px;
  font-weight: 500;
  color: #6e6e73;
  margin-top: 6px;
}

h3 {
  font-size: 16px;
  font-weight: 600;
  margin: 0 0 12px;
  color: #3a3a3c;
}

.page-header {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 24px;
}

.header-subtitle {
  font-size: 15px;
  color: #5a5a5f;
  margin: 0;
}

.page-link {
  font-size: 14px;
  font-weight: 600;
  color: #007aff;
  text-decoration: none;
}

.page-link:hover {
  text-decoration: underline;
}

/* =========================
   CARDS
========================= */
.card {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 24px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.06);
  border: 1px solid rgba(0, 0, 0, 0.04);
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 12px;
}

.helper-text {
  margin: 0 0 12px;
  font-size: 13px;
  color: #6e6e73;
}

/* =========================
   INPUTS
========================= */
input, textarea, button {
  font-family: inherit;
}

input, textarea {
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid #d1d1d6;
  font-size: 15px;
}

input:focus, textarea:focus {
  outline: none;
  border-color: #007aff;
}

input:focus-visible, textarea:focus-visible, button:focus-visible {
  outline: 2px solid #007aff;
  outline-offset: 2px;
}

/* =========================
   BUTTONS
========================= */
button {
  padding: 12px 16px;
  border-radius: 14px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  background-color: #007aff;
  color: white;
  box-shadow: 0 6px 14px rgba(0,122,255,0.25);
  transition: transform 0.1s ease, box-shadow 0.1s ease;
}

button:hover { transform: translateY(-1px); }
button:active {
  transform: translateY(1px);
  box-shadow: 0 3px 8px rgba(0,122,255,0.25);
}

button.secondary {
  background: #28a745;
  box-shadow: 0 6px 14px rgba(40,167,69,0.25);
}

.field-label {
  display: block;
  margin-bottom: 6px;
  font-size: 13px;
  font-weight: 600;
  color: #5a5a5f;
}

/* =========================
   DARK MODE
========================= */
body.dark-mode {
  background: linear-gradient(#1c1c1e, #000);
  color: #f2f2f7; /* ðŸ”‘ makes MOST text white */
}

/* Headings */
body.dark-mode h1,
body.dark-mode h3 {
  color: #f2f2f7;
}

/* Cards */
body.dark-mode .card {
  background: #2c2c2e;
  box-shadow: 0 8px 20px rgba(0,0,0,0.6);
  border-color: rgba(255, 255, 255, 0.08);
}

/* Inputs & textareas */
body.dark-mode input,
body.dark-mode textarea {
  background: #1c1c1e;
  color: #f2f2f7;
  border-color: #3a3a3c;
}

/* Buttons */
body.dark-mode button {
  background-color: #0a84ff;
}

/* Secondary button */
body.dark-mode button.secondary {
  background-color: #30d158;
}

/* Autocomplete suggestions */
body.dark-mode .suggestions {
  background: #2c2c2e;
}

body.dark-mode .suggestion-item {
  color: #f2f2f7;
}

body.dark-mode .suggestion-item:hover,
body.dark-mode .suggestion-item.active {
  background: #3a3a3c;
}

/* Selected pills */
body.dark-mode .selected-pill {
  background: #3a3a3c;
  border-color: #48484a;
}

body.dark-mode .selected-pill span {
  color: #ff453a;
}

/* Tables */
body.dark-mode .table {
  background: #2c2c2e;
}

body.dark-mode li {
  background: #1c1c1e;
  color: #f2f2f7;
  border-color: #3a3a3c;
}

/* Footer */
body.dark-mode .footer-text {
  color: #8e8e93;
}

body.dark-mode h1 span {
  color: #8e8e93;
}

body.dark-mode .header-subtitle,
body.dark-mode .helper-text,
body.dark-mode .field-label {
  color: #b0b0b5;
}

body.dark-mode .page-link {
  color: #66a7ff;
}

/* =========================
   MODE TOGGLE
========================= */
.mode-buttons {
  display: flex;
  gap: 6px;
  background: #f2f2f7;
  padding: 6px;
  border-radius: 999px;
  margin-bottom: 24px;
}

.toolbar {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  margin-bottom: 24px;
  padding: 12px 16px;
  border-radius: 16px;
  background: rgba(255, 255, 255, 0.7);
  border: 1px solid rgba(0, 0, 0, 0.05);
  box-shadow: 0 8px 16px rgba(0,0,0,0.06);
}

.toggle-button {
  background: white;
  color: #007aff;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  border: 1px solid rgba(0, 0, 0, 0.06);
}

.toggle-button.dark-on {
  background: #1c1c1e;
  color: #f2f2f7;
}

.mode-button {
  flex: 1;
  background: transparent;
  color: #3a3a3c;
  box-shadow: none;
}

.mode-button.active-mode {
  background: white;
  color: #007aff;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.collab-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

#collabDisplayName {
  width: 150px;
}

.collab-controls input {
  width: 170px;
  padding: 10px;
}

#collabStatus {
  margin: 0;
  font-size: 12px;
}

body.dark-mode .collab-controls input {
  background: #1c1c1e;
  color: #f2f2f7;
  border-color: #3a3a3c;
}

.presence-card {
  border-left: 4px solid #007aff;
}

#presenceSummary {
  margin: 0;
  font-weight: 600;
}

#presenceList {
  margin: 8px 0 0;
  padding-left: 18px;
}

#presenceList li {
  cursor: default;
}

/* =========================
   AUTOCOMPLETE
========================= */
.autocomplete-box { position: relative; }

.suggestions {
  position: absolute;
  width: 100%;
  margin-top: 6px;
  background: white;
  border-radius: 12px;
  max-height: 180px;
  overflow-y: auto;
  box-shadow: 0 10px 25px rgba(0,0,0,0.12);
  z-index: 20;
  border: 1px solid rgba(0,0,0,0.08);
}

.suggestion-item {
  padding: 10px 12px;
  cursor: pointer;
}

.suggestion-item:hover,
.suggestion-item.active {
  background: #e9f2ff;
}

/* =========================
   SELECTED PILLS
========================= */
.selected-pill {
  display: inline-block;
  padding: 6px 12px;
  margin: 4px;
  border-radius: 20px;
  background: #f2f2f7;
  border: 1px solid #d1d1d6;
}

.selected-pill span {
  margin-left: 8px;
  color: #ff3b30;
  cursor: pointer;
  font-weight: bold;
}

.note-box {
  width: 100%;
  margin: 6px 0 12px;
  padding: 8px;
  border-radius: 10px;
  border: 1px solid #d1d1d6;
  resize: vertical;
  transition: max-height 0.2s ease, opacity 0.2s ease;
}

.note-box.collapsed {
  max-height: 0;
  opacity: 0;
  padding: 0;
  margin: 0;
  border: 0;
  overflow: hidden;
  pointer-events: none;
}

.note-toggle {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  margin: 4px 0 10px;
  border-radius: 50%;
  border: 1px solid #d1d1d6;
  background: #f2f2f7;
  color: #3a3a3c;
  font-size: 14px;
  cursor: pointer;
  box-shadow: none;
  padding: 0;
}

.note-toggle:hover {
  background: #e5e5ea;
  transform: none;
  box-shadow: none;
}

.together-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin: 10px 0 0;
}

.together-buttons button {
  padding: 8px 12px;
  border-radius: 999px;
  background: #f2f2f7;
  color: #3a3a3c;
  border: 1px solid #d1d1d6;
  box-shadow: none;
  font-weight: 600;
}

.together-buttons button:hover {
  transform: none;
  background: #e9f2ff;
}

body.dark-mode .together-buttons button {
  background: #3a3a3c;
  border-color: #48484a;
  color: #f2f2f7;
}

body.dark-mode .together-buttons button:hover {
  background: #2f4b76;
}

body.dark-mode .note-toggle {
  background: #3a3a3c;
  border-color: #48484a;
  color: #f2f2f7;
}

body.dark-mode .note-toggle:hover {
  background: #48484a;
}

/* =========================
   TABLES
========================= */
#output {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
  gap: 16px;
  margin-top: 16px;
}

.table {
  background: white;
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.06);
  border: 1px solid rgba(0, 0, 0, 0.05);
}

.table h3 {
  margin-top: 0;
  border-bottom: 1px solid #e5e5ea;
  padding-bottom: 8px;
}

li {
  list-style: none;
  padding: 8px 10px;
  margin: 6px 0;
  border: 1px solid #e5e5ea;
  border-radius: 8px;
  cursor: grab;
  background: #fff;
}

/* ========================= */
.hidden { display: none; }
.visually-hidden {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  border: 0;
}
.footer-text {
  margin-top: 40px;
  font-size: 12px;
  color: #6e6e73;
  text-align: center;
}

.live-counter {
  margin-bottom: 12px;
  font-size: 14px;
  color: #3a3a3c;
  display: flex;
  gap: 16px;
  font-weight: 600;
}

body.dark-mode .live-counter {
  color: #d1d1d6;
}

body.dark-mode .toolbar {
  background: rgba(44, 44, 46, 0.9);
  border-color: rgba(255, 255, 255, 0.08);
}

body.dark-mode .mode-buttons {
  background: #3a3a3c;
}

body.dark-mode .suggestion-item:hover,
body.dark-mode .suggestion-item.active {
  background: #2f4b76;
}


</style>
</head>

<body>
<div id="appContent">
<header class="page-header">
  <h1>Saint Thomas Youth Group Attendance <span>Track attendance, tables, and notes</span></h1>
  Click <a class="page-link" href="points-calculator.html">here</a> for spreadsheet point totals.
</header>

<div class="toolbar">
  <div class="mode-buttons" role="group" aria-label="Select attendance event">
    <button type="button" id="rosaryBtn" class="mode-button" onclick="setMode('rosary')">Rosary</button>
    <button type="button" id="youthBtn" class="mode-button active-mode" onclick="setMode('youth')">Youth Group</button>
    <button type="button" id="holyHourBtn" class="mode-button" onclick="setMode('holyHour')">Holy Hour</button>
    <button type="button" id="serviceBtn" class="mode-button" onclick="setMode('service')">Service</button>
  </div>

  <button type="button" id="darkModeBtn" class="toggle-button" onclick="toggleDarkMode()" aria-pressed="false">Enable Dark Mode</button>

  <div class="collab-controls">
    <label class="visually-hidden" for="collabDisplayName">Your name</label>
    <input id="collabDisplayName" type="text" placeholder="Your name" autocomplete="off">
    <label class="visually-hidden" for="sessionCodeInput">Collab session code</label>
    <input id="sessionCodeInput" type="text" placeholder="Session code" autocomplete="off">
    <label class="visually-hidden" for="sessionKeyInput">Collab secret key</label>
    <input id="sessionKeyInput" type="password" placeholder="Secret key" autocomplete="off">
    <button type="button" id="connectSessionBtn" class="toggle-button">Connect Session</button>
    <span id="collabStatus" class="helper-text">Collab: Off</span>
  </div>
</div>

<div class="card presence-card">
  <div class="card-header">
    <h3>Live collaborators</h3>
  </div>
  <p id="presenceSummary" class="helper-text">Connect a session to see collaborators.</p>
  <ul id="presenceList"></ul>
</div>

<div class="card">
  <div class="card-header">
    <h3>Present Attendees</h3>
  </div>
  <div class="autocomplete-box">
    <label class="field-label" for="presentInput">Add present attendee</label>
    <input id="presentInput" placeholder="Type a name..." autocomplete="off" aria-autocomplete="list" aria-controls="presentSuggestions">
    <div id="presentSuggestions" class="suggestions" role="listbox"></div>
  </div>
  <div id="presentSelected"></div>
</div>

<div id="youthFeatures">

  <div class="card">
    <div class="card-header">
      <h3>Core Members</h3>
    </div>
    <div class="autocomplete-box">
      <label class="field-label" for="coreInput">Add core member</label>
      <input id="coreInput" placeholder="Type a core member..." autocomplete="off" aria-autocomplete="list" aria-controls="coreSuggestions">
      <div id="coreSuggestions" class="suggestions" role="listbox"></div>
    </div>
    <div id="coreSelected"></div>
  </div>

  <div class="card">
    <div class="card-header">
      <h3>Groups That Must Sit Together</h3>
    </div>
    <label class="field-label" for="togetherGroups">Group list</label>
    <textarea id="togetherGroups" placeholder="One group per line: Name, Name, Name"></textarea>
    <p class="helper-text">Tap a present name to add it to the current group line.</p>
    <div id="togetherNameButtons" class="together-buttons" aria-live="polite"></div>

    <h3>Number of Tables</h3>
    <label class="field-label" for="numTables">Total tables</label>
    <input type="number" id="numTables" min="1" value="8">

    <br><br>
    <button type="button" onclick="generateTables()">Generate Tables</button>

    <div id="output"></div>
  </div>

</div>

<div class="card">
  <div class="card-header">
    <h3>Point Settings</h3>
  </div>
  <p class="helper-text">Change point values anytime. Core members receive the multiplier shown below.</p>
  <div class="grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;">
    <div>
      <label class="field-label" for="pointsRosary">Rosary points</label>
      <input id="pointsRosary" type="number" min="0" step="1" value="8">
    </div>
    <div>
      <label class="field-label" for="pointsYouth">Youth Group points</label>
      <input id="pointsYouth" type="number" min="0" step="1" value="20">
    </div>
    <div>
      <label class="field-label" for="pointsHolyHour">Holy Hour points</label>
      <input id="pointsHolyHour" type="number" min="0" step="1" value="15">
    </div>
    <div>
      <label class="field-label" for="pointsService">Service points</label>
      <input id="pointsService" type="number" min="0" step="1" value="30">
    </div>
    <div>
      <label class="field-label" for="coreMultiplier">Core multiplier</label>
      <input id="coreMultiplier" type="number" min="1" step="0.01" value="1.25">
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h3>Attendance List</h3>
  </div>

  <!-- LIVE COUNTER -->
  <div id="liveCounter" class="live-counter" aria-live="polite"></div>

  <label class="field-label" for="copyList">Attendance output</label>
  <textarea id="copyList" rows="8" placeholder="Marked attendees will appear here..."></textarea>
  <br><br>
  <button type="button" class="secondary" onclick="exportToCSV()">Export to CSV</button>
</div>

<div class="footer-text">
  Â© 2026 Saint Thomas the Apostle Youth Group Â· Raphael Ide
</div>

<div class="footer-text">
   Click <a href="https://files.ecatholic.com/20819/documents/2026/2/Top%2050%20Point%20Scorers.pdf?t=1770505299000">here</a> to see the current point standings!!
</div>

</div>

<script src="https://unpkg.com/yjs@13.6.18/dist/yjs.js"></script>
<script src="https://unpkg.com/y-websocket@1.5.3/dist/y-websocket.js"></script>
<script src="https://unpkg.com/y-webrtc@10.3.0/dist/y-webrtc.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-database-compat.js"></script>

<script>
/* =========================
   DATA
========================= */
const allAttendees = [
  'Mara Wesolowski','Allie Choate','Bria Santoro','MariaTeresa Arena',
  'Danny Kuyrouz','Amelia Cannato','Carmine Arena','Francesco Arena',
  'Winnie McLaughlin','Caroline Lally','Luke Walsh','Flynn Walsh','James Bowman',
  'Emmie Valenzuela','Antony Marcucci','Maggie Woodard','Amelia Choate',
  'Andrew Foraker','Bella Calvo','Ben Biggins','Blake Masso','Will OBrien',
  'Bridget Gonya','Caroline Gonya','Bowman Rhinesmith','Cat Choate','Catalina Calvo',
  'Catarina Franchi','Catherine McLaughlin','Cecelia Lateo','Charbel Almacari',
  'Charlotte Keefe','Christine Cheely','Sammy Biggins','Clare Walsh','Cormac Doyle',
  'Dermot O\'Boyle','Dottie Mahoney','Kaylee Cumming','Elizabeth Brown','Ella Hill',
  'Emilia Parrella','Emily Rameaka','Owen Rameaka','Grace Ahearn','Grace Finnegan',
  'Grace Garvey','Grace Lynch','Graham Evans','Nicholas Arico','Grace Nohrden','Griffin Masso',
  'Hannah Keefe','Meghan Gonya','Joseph Cumming','Illai Gutierrez','Immanuel Marmol',
  'James Golden','James Marcucci','James Walsh','Jenna Gorman','JJ Bachiochi',
  'John Enriquez','John Nohrden','John Sullivan','Joseph Brennan','JP Golden',
  'Julianna Gutierrez','Kate Worcester','Keira Parrella','Libby Hamel',
  'Lily Nohrden','Livina Vaz','Luke Bachiochi','Michael Gonya','Maeve Walsh',
  'Maggie Arico','Mairead Flynn','Abby Biggins','Marae McCarthy','Maria McQuade',
  'MaryRose Mahoney','Thomas Mahoney','Matthew Brennan','Mia Driscoll','Mia Fiala','Michael Kenney',
  'Michelle Ide','Mitch Finnegan','Nathan Behrmann','Nico Reardon','Noah Crowder',
  'Noelle Watt','Nora Konetzny','Paul Mahoney','Owen Gonet','Paul Haggarty','Penny Awad',
  'Peter Keefe','Reese Masso','Sophia Nicholson','Stella Driscoll','Ted Worcester',
  'Thomas Cleary','Tim Hill','Timmy Brown','Tom Marcucci','Tommy Biggins',
  'Tommy Hamel','Will Enriquez','Will Finnegan','Nicholas McCarty','Will Vaccaro','Winnie Subber',
  'Wyatt Subber','Xavier Bogart','Raphael Ide','Gigi Arico','Maria Elena Franchi','Natalia McLaughlin',
  'Cece McLaughlin','Genevieve Nohrden','Catalina Perdomo','Bella Gonet',
  'Ali Hamel','Ella Cronin','Alina Falcao','Paxton Roper','Caterina Franchi',
  'Alex Matiolli','Matt Cunis','Keira Hyatt','MJ Phelps','Mary Marshall',
  'Xavien Crowder','James Kerr','Irena Sabtchev','Paulina Arena','Leah Vaz',
  'Jane Marino','Ali Walsh','Natalie Bowman','Annabell Malow','Claire Olohan',
  'Jonathan Thomas','Mason Conlon','Allie Fetter','Charlie Phelps','Jackie Sparks',
  'Keegan Masso','Paul Murphy','Eamon Keefe','Lyla McCarthy','Eli Joanis',
  'Henry Bowman','John Nelson','Lucy Tierney','Sara Johnson','Sarah Flaherty',
  'Caleb Wells','Caroline Kenney','Cece Whallen','Daniel Woods','Kevin Judge',
  'Luke Brown','Nicholas Montalbano','Elizabeth Barrette','Jack Finnegan','Hayley Grinn',
  'Jacky Grinn','Alana Hyatt','Ali Fetter','Andrew DiBartola','Ava Robinson',
  'Ben Vaccarro','Caroline Bernier','Clare Higgins','Dan Warren','Daniel Woodard',
  'Elizabeth Brennan','Gabby Graziano','Henry Awad','Kat Flynn','Logan Conlon',
  'Luli Martinez','Maggie Roche','Midas Videra','Nick Arico','Nora Burke','Olivia Peterson',
  'Shannon Burke','Teddy Robertson','Thomas Behrmann','Victoria Florez','Will Parrella',
  'Anne Marie Nohrden','Aniya Gutierrez'
];

const defaultCore = [
  "Raphael Ide","Gigi Arico","Maria Elena Franchi","Natalia McLaughlin",
  "Cece McLaughlin","Genevieve Nohrden","Catalina Perdomo","Bella Gonet",
  "Ali Hamel","Ella Cronin","Alina Falcao","Paxton Roper"
];

const EVENT_LABELS = {
  rosary: "Rosary",
  youth: "Youth Group",
  holyHour: "Holy Hour",
  service: "Service"
};

const POINTS_STORAGE_KEY = "st_thomas_points_settings_v1";
let eventPoints = { rosary: 8, youth: 20, holyHour: 15, service: 30 };
let coreMultiplier = 1.25;

let presentList = [];
let coreList = [];
let tables = [];
let currentMode = 'youth';

const listRenderers = {};
let isApplyingRemoteState = false;
let yDoc = null;
let yProviders = [];
let yStateMap = null;
let awarenessUnsubscribers = [];
let collabChannel = null;
let collabStorageKey = "";
let collabSessionCode = "";
let collabSessionRoom = "";
let collabCryptoKeyPromise = null;
let collabSaltBase64 = "";
let localCollabId = `${Date.now()}-${Math.random().toString(36).slice(2, 10)}`;
let presenceHeartbeatTimer = null;
let cleanupPresenceHandler = null;
let latestStateTimestamp = 0;
let firebaseApp = null;
let firebaseDb = null;
let firebaseSessionRef = null;
let firebaseUnsubscribe = null;
const COLLAB_NAME_STORAGE_KEY = "st-attendance-collab-name";
const PBKDF2_ITERATIONS = 250000;

function getCurrentState() {
  return {
    presentList,
    coreList,
    tables,
    currentMode,
    eventPoints,
    coreMultiplier,
    togetherGroups: document.getElementById("togetherGroups")?.value || "",
    numTables: document.getElementById("numTables")?.value || "8",
    darkMode: document.body.classList.contains("dark-mode")
  };
}

function bytesToBase64(bytes) {
  return btoa(String.fromCharCode(...bytes));
}

function base64ToBytes(base64) {
  const binary = atob(base64);
  return Uint8Array.from(binary, char => char.charCodeAt(0));
}

async function sha256Hex(value) {
  const data = new TextEncoder().encode(value);
  const digest = await crypto.subtle.digest("SHA-256", data);
  return Array.from(new Uint8Array(digest))
    .map(byte => byte.toString(16).padStart(2, "0"))
    .join("");
}

async function deriveSessionKey(secret, saltBytes) {
  const keyMaterial = await crypto.subtle.importKey(
    "raw",
    new TextEncoder().encode(secret),
    "PBKDF2",
    false,
    ["deriveKey"]
  );

  return crypto.subtle.deriveKey(
    {
      name: "PBKDF2",
      salt: saltBytes,
      iterations: PBKDF2_ITERATIONS,
      hash: "SHA-256"
    },
    keyMaterial,
    { name: "AES-GCM", length: 256 },
    false,
    ["encrypt", "decrypt"]
  );
}

async function encryptCollabPayload(plaintext) {
  if (!collabCryptoKeyPromise || !collabSaltBase64) return plaintext;

  const cryptoKey = await collabCryptoKeyPromise;
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const encrypted = await crypto.subtle.encrypt(
    { name: "AES-GCM", iv },
    cryptoKey,
    new TextEncoder().encode(plaintext)
  );

  return JSON.stringify({
    v: 1,
    s: collabSaltBase64,
    i: bytesToBase64(iv),
    d: bytesToBase64(new Uint8Array(encrypted))
  });
}

async function decryptCollabPayload(raw) {
  if (!raw) return null;

  let envelope;
  try {
    envelope = JSON.parse(raw);
  } catch {
    return raw;
  }

  if (!envelope || envelope.v !== 1 || !envelope.s || !envelope.i || !envelope.d) {
    return raw;
  }

  const secretInput = document.getElementById("sessionKeyInput");
  const secret = secretInput?.value.trim();
  if (!secret) return null;

  const key = await deriveSessionKey(secret, base64ToBytes(envelope.s));
  const decrypted = await crypto.subtle.decrypt(
    { name: "AES-GCM", iv: base64ToBytes(envelope.i) },
    key,
    base64ToBytes(envelope.d)
  );

  return new TextDecoder().decode(decrypted);
}

function getFirebaseConfig() {
  const runtimeConfig = window.ST_ATTENDANCE_FIREBASE_CONFIG;
  if (runtimeConfig && typeof runtimeConfig === "object") return runtimeConfig;

  return {
    apiKey: "",
    authDomain: "",
    databaseURL: "",
    projectId: "",
    appId: ""
  };
}

function initializeFirebaseBackend() {
  if (!window.firebase) return false;
  const config = getFirebaseConfig();
  if (!config.apiKey || !config.databaseURL || !config.projectId || !config.appId) {
    return false;
  }

  if (!firebaseApp) {
    firebaseApp = firebase.apps?.length ? firebase.app() : firebase.initializeApp(config);
  }
  if (!firebaseDb) {
    firebaseDb = firebase.database(firebaseApp);
  }
  return true;
}

function stopFirebaseSubscription() {
  if (firebaseUnsubscribe) {
    firebaseUnsubscribe();
    firebaseUnsubscribe = null;
  }
  firebaseSessionRef = null;
}

async function publishCollabState() {
  if (isApplyingRemoteState) return;
  const payload = JSON.stringify({ ...getCurrentState(), updatedAt: Date.now() });
  const securedPayload = await encryptCollabPayload(payload);

  if (yStateMap) yStateMap.set("payload", securedPayload);
  if (collabChannel) collabChannel.postMessage(securedPayload);
  if (collabStorageKey) localStorage.setItem(collabStorageKey, securedPayload);
  if (firebaseSessionRef) {
    await firebaseSessionRef.set({
      payload: securedPayload,
      updatedAt: Date.now(),
      author: localCollabId
    });
  }
}

async function applyIncomingState(raw) {
  if (!raw) return;

  const decoded = await decryptCollabPayload(raw);
  if (!decoded) return;

  let state;
  try {
    state = JSON.parse(decoded);
  } catch {
    return;
  }

  const timestamp = Number(state.updatedAt) || 0;
  if (timestamp && timestamp < latestStateTimestamp) return;
  if (timestamp) latestStateTimestamp = timestamp;

  isApplyingRemoteState = true;

  if (Array.isArray(state.presentList)) {
    presentList.splice(0, presentList.length, ...state.presentList);
  }
  if (Array.isArray(state.coreList)) {
    coreList.splice(0, coreList.length, ...state.coreList);
  }
  if (Array.isArray(state.tables)) {
    tables.splice(0, tables.length, ...state.tables);
  }

  if (typeof state.currentMode === "string") {
    setMode(state.currentMode);
  }

  if (state.eventPoints && typeof state.eventPoints === "object") {
    eventPoints = { ...eventPoints, ...state.eventPoints };
    syncPointInputs();
  }

  if (typeof state.coreMultiplier === "number") {
    coreMultiplier = state.coreMultiplier;
    syncPointInputs();
  }

  const together = document.getElementById("togetherGroups");
  if (together && typeof state.togetherGroups === "string") {
    together.value = state.togetherGroups;
  }

  const numTables = document.getElementById("numTables");
  if (numTables && typeof state.numTables === "string") {
    numTables.value = state.numTables;
  }

  if (typeof state.darkMode === "boolean") {
    document.body.classList.toggle("dark-mode", state.darkMode);
    const button = document.getElementById("darkModeBtn");
    if (button) {
      button.classList.toggle("dark-on", state.darkMode);
      button.setAttribute("aria-pressed", state.darkMode ? "true" : "false");
      button.textContent = state.darkMode ? "Turn off Dark Mode" : "Turn on Dark Mode";
    }
  }

  Object.values(listRenderers).forEach(render => render());
  renderTables();
  updateCopyList();

  isApplyingRemoteState = false;
}

function queueApplyIncomingState(raw) {
  applyIncomingState(raw).catch(() => {
    const status = document.getElementById("collabStatus");
    if (status) status.textContent = "Collab: Unable to decrypt incoming update";
  });
}

function getCollabDisplayName() {
  const input = document.getElementById("collabDisplayName");
  const trimmed = input?.value.trim();
  return trimmed || localStorage.getItem(COLLAB_NAME_STORAGE_KEY) || "Anonymous";
}

function setAwarenessState() {
  if (!yProviders.length) return;
  const displayName = getCollabDisplayName();
  localStorage.setItem(COLLAB_NAME_STORAGE_KEY, displayName);
  yProviders.forEach(provider => {
    provider.awareness.setLocalStateField("user", {
      id: localCollabId,
      name: displayName
    });
  });
}

function refreshPresenceCard() {
  const summary = document.getElementById("presenceSummary");
  const list = document.getElementById("presenceList");
  if (!summary || !list) return;

  if (!collabSessionCode || !yProviders.length) {
    summary.textContent = "Connect a session to see collaborators.";
    list.innerHTML = "";
    return;
  }

  const awarenessStates = yProviders.flatMap(provider => Array.from(provider.awareness.getStates().values()));
  const usersById = new Map();

  awarenessStates.forEach(state => {
    const user = state?.user;
    if (!user || !user.id) return;
    usersById.set(user.id, {
      id: user.id,
      name: user.name || "Anonymous"
    });
  });

  const others = Array.from(usersById.values()).filter(user => user.id !== localCollabId);
  if (!others.length) {
    summary.textContent = "No one else is in this file right now.";
    list.innerHTML = "";
    return;
  }

  summary.textContent = `${others.length} collaborator${others.length === 1 ? "" : "s"} currently editing this file.`;
  list.innerHTML = "";
  others
    .sort((a, b) => String(a.name).localeCompare(String(b.name)))
    .forEach(user => {
      const item = document.createElement("li");
      item.textContent = user.name;
      list.appendChild(item);
    });
}

function stopPresenceHeartbeat() {
  if (presenceHeartbeatTimer) {
    window.clearInterval(presenceHeartbeatTimer);
    presenceHeartbeatTimer = null;
  }
  if (cleanupPresenceHandler) {
    window.removeEventListener("beforeunload", cleanupPresenceHandler);
    cleanupPresenceHandler = null;
  }
}

function removeLocalPresence() {
  if (!yProviders.length) return;
  yProviders.forEach(provider => provider.awareness.setLocalStateField("user", null));
  refreshPresenceCard();
}

function startPresenceHeartbeat(code) {
  stopPresenceHeartbeat();
  collabSessionCode = code;

  setAwarenessState();
  refreshPresenceCard();

  presenceHeartbeatTimer = window.setInterval(() => {
    if (!yProviders.length) return;
    setAwarenessState();
    refreshPresenceCard();
  }, 5000);

  cleanupPresenceHandler = () => removeLocalPresence();
  window.addEventListener("beforeunload", cleanupPresenceHandler);
}

async function connectCollabSession() {
  const codeInput = document.getElementById("sessionCodeInput");
  const secretInput = document.getElementById("sessionKeyInput");
  const status = document.getElementById("collabStatus");
  const code = codeInput?.value.trim();
  const secret = secretInput?.value.trim();

  if (!code) {
    if (status) status.textContent = "Collab: Enter a session code";
    return;
  }

  if (!secret || secret.length < 8) {
    if (status) status.textContent = "Collab: Secret key must be at least 8 characters";
    return;
  }

  removeLocalPresence();
  if (collabChannel) collabChannel.close();

  collabSessionRoom = await sha256Hex(`st-room-${code.toLowerCase()}`);
  collabStorageKey = `st-attendance-${collabSessionRoom.slice(0, 24)}`;
  collabChannel = new BroadcastChannel(collabStorageKey);
  collabChannel.onmessage = event => queueApplyIncomingState(event.data);

  awarenessUnsubscribers.forEach(unsub => unsub());
  awarenessUnsubscribers = [];
  yProviders.forEach(provider => provider.destroy());
  if (yDoc) yDoc.destroy();
  yProviders = [];
  yDoc = null;
  yStateMap = null;
  latestStateTimestamp = 0;
  stopFirebaseSubscription();

  collabSaltBase64 = bytesToBase64(crypto.getRandomValues(new Uint8Array(16)));
  collabCryptoKeyPromise = deriveSessionKey(secret, base64ToBytes(collabSaltBase64));

  if (window.Y) {
    yDoc = new Y.Doc();

    if (window.WebsocketProvider) {
      const wsProvider = new WebsocketProvider("wss://demos.yjs.dev", collabStorageKey, yDoc);
      yProviders.push(wsProvider);
      wsProvider.on("status", event => {
        if (status && event?.status) {
          const wsText = event.status === "connected" ? "online" : "reconnecting";
          status.textContent = `Collab: ${wsText} (${code})`;
        }
      });
    }

    if (window.WebrtcProvider) {
      const rtcProvider = new WebrtcProvider(collabStorageKey, yDoc, {
        signaling: [
          "wss://signaling.yjs.dev",
          "wss://y-webrtc-signaling-eu.herokuapp.com",
          "wss://y-webrtc-signaling-us.herokuapp.com"
        ]
      });
      yProviders.push(rtcProvider);
    }

    yStateMap = yDoc.getMap("attendance");
    yStateMap.observe(() => queueApplyIncomingState(yStateMap.get("payload")));

    yProviders.forEach(provider => {
      const awarenessHandler = () => refreshPresenceCard();
      provider.awareness.on("change", awarenessHandler);
      awarenessUnsubscribers.push(() => provider.awareness.off("change", awarenessHandler));
    });
  }

  if (initializeFirebaseBackend()) {
    firebaseSessionRef = firebaseDb.ref(`sessions/${collabStorageKey}`);
    const firebaseHandler = snapshot => {
      const value = snapshot.val();
      if (!value?.payload) return;
      if (value.author === localCollabId) return;
      queueApplyIncomingState(value.payload);
    };
    firebaseSessionRef.on("value", firebaseHandler);
    firebaseUnsubscribe = () => firebaseSessionRef?.off("value", firebaseHandler);
    if (status) status.textContent = `Collab: Firebase + P2P connected (${code})`;
  }

  const existingPayload = localStorage.getItem(collabStorageKey);
  if (existingPayload) {
    queueApplyIncomingState(existingPayload);
  }

  startPresenceHeartbeat(code);
  await publishCollabState();

  if (status && !yProviders.length && !firebaseSessionRef) {
    status.textContent = `Collab: Local secure sync only (${code})`;
  } else if (status && firebaseSessionRef) {
    status.textContent = `Collab: Firebase-backed sync active (${code})`;
  }
}

function normalizeName(value) {
  return value.trim().replace(/\s+/g, " ");
}

function appendNameToTogetherGroup(name) {
  const textarea = document.getElementById("togetherGroups");
  if (!textarea) return;

  const current = textarea.value;
  if (!current.trim()) {
    textarea.value = name;
  } else if (current.endsWith("\n")) {
    textarea.value = `${current}${name}`;
  } else {
    textarea.value = `${current}, ${name}`;
  }
  textarea.focus();
}

function updateTogetherButtons() {
  const container = document.getElementById("togetherNameButtons");
  if (!container) return;

  container.innerHTML = "";
  const names = presentList.map(p => p.name).sort((a, b) => a.localeCompare(b));

  if (!names.length) {
    const empty = document.createElement("span");
    empty.className = "helper-text";
    empty.textContent = "Mark attendees present to see name buttons here.";
    container.appendChild(empty);
    return;
  }

  names.forEach(name => {
    const button = document.createElement("button");
    button.type = "button";
    button.textContent = name;
    button.addEventListener("click", () => appendNameToTogetherGroup(name));
    container.appendChild(button);
  });
}

/* =========================
   AUTOCOMPLETE
========================= */
function setupAutocomplete(
  inputId,
  suggestionsId,
  selectedId,
  sourceList,
  targetArray,
  withNotes = false
) {
  const input = document.getElementById(inputId);
  const suggestions = document.getElementById(suggestionsId);
  const selected = document.getElementById(selectedId);

  let activeIndex = -1;
  input.setAttribute("aria-expanded", "false");

  function renderSuggestions() {
    const query = input.value.toLowerCase();
    suggestions.innerHTML = "";

    if (!query) {
      input.setAttribute("aria-expanded", "false");
      return;
    }

    const matches = sourceList.filter(
      name =>
        name.toLowerCase().includes(query) &&
        !targetArray.some(o => o.name === name)
    );

    matches.forEach((name, index) => {
      const div = document.createElement("div");
      div.className = "suggestion-item";
      div.setAttribute("role", "option");
      div.setAttribute("aria-selected", index === activeIndex ? "true" : "false");
      div.textContent = name;
      if (index === activeIndex) div.classList.add("active");

      div.onclick = () => selectName(name);
      suggestions.appendChild(div);
    });

    input.setAttribute("aria-expanded", matches.length ? "true" : "false");
  }

  function renderSelected() {
    selected.innerHTML = "";

    targetArray.forEach(obj => {
      const pill = document.createElement("div");
      pill.className = "selected-pill";
      pill.innerHTML = `${obj.name} <span>Ã—</span>`;

      pill.querySelector("span").onclick = () => {
        const name = obj.name;

        // remove from this list
        targetArray.splice(targetArray.indexOf(obj), 1);

        // ðŸ”‘ removing PRESENT also removes CORE
        if (targetArray === presentList) {
          coreList = coreList.filter(c => c.name !== name);
        }

        renderSelected();
        updateCopyList();
      };

      selected.appendChild(pill);

      if (withNotes) {
        const toggle = document.createElement("button");
        toggle.type = "button";
        toggle.className = "note-toggle";
        toggle.setAttribute("aria-label", "Toggle notes");
        toggle.textContent = "â–¶";

        const note = document.createElement("textarea");
        note.className = "note-box collapsed";
        note.placeholder = "Notes...";
        note.value = obj.notes;
        const setExpanded = expanded => {
          note.classList.toggle("collapsed", !expanded);
          toggle.textContent = expanded ? "â–¼" : "â–¶";
        };

        toggle.addEventListener("click", () => {
          const isCollapsed = note.classList.contains("collapsed");
          setExpanded(isCollapsed);
          if (isCollapsed) {
            note.focus();
          }
        });

        note.addEventListener("input", () => {
          obj.notes = note.value;
          publishCollabState();
        });

        setExpanded(false);
        selected.appendChild(toggle);
        selected.appendChild(note);
      }
    });

    updateCopyList();
    updateTogetherButtons();
    publishCollabState();
  }

  function selectName(name) {
    if (!targetArray.some(o => o.name === name)) {
      targetArray.push({ name, notes: "" });
    }

    // ðŸ”‘ CORE âŠ† PRESENT
    if (targetArray === coreList) {
      if (!presentList.some(p => p.name === name)) {
        presentList.push({ name, notes: "" });
      }
    }

    input.value = "";
    suggestions.innerHTML = "";
    input.setAttribute("aria-expanded", "false");
    activeIndex = -1;

    renderSelected();
  }

  function maybeAddNewName(rawName) {
    const name = normalizeName(rawName);
    if (!name) return false;

    const existing = sourceList.find(
      entry => entry.toLowerCase() === name.toLowerCase()
    );

    if (existing) {
      selectName(existing);
      return true;
    }

    if (window.confirm(`"${name}" is not in the list yet. Add this person?`)) {
      sourceList.push(name);
      selectName(name);
      return true;
    }

    return false;
  }

  input.addEventListener("input", renderSuggestions);

  input.addEventListener("blur", () => {
    setTimeout(() => {
      suggestions.innerHTML = "";
      input.setAttribute("aria-expanded", "false");
      activeIndex = -1;
    }, 100);
  });

  input.addEventListener("keydown", e => {
    const items = suggestions.querySelectorAll(".suggestion-item");
    if (e.key === "Escape") {
      suggestions.innerHTML = "";
      input.setAttribute("aria-expanded", "false");
      activeIndex = -1;
      return;
    }

    if (e.key === "Enter") {
      e.preventDefault();
      if (items[activeIndex]) {
        selectName(items[activeIndex].textContent);
        return;
      }

      if (items.length) {
        selectName(items[0].textContent);
        return;
      }

      if (maybeAddNewName(input.value)) {
        renderSuggestions();
        return;
      }
    }

    if (!items.length) return;

    if (e.key === "ArrowDown") {
      activeIndex = (activeIndex + 1) % items.length;
    }

    if (e.key === "ArrowUp") {
      activeIndex = (activeIndex - 1 + items.length) % items.length;
    }

    items.forEach((el, i) =>
      el.classList.toggle("active", i === activeIndex)
    );

    items.forEach((el, i) =>
      el.setAttribute("aria-selected", i === activeIndex ? "true" : "false")
    );
  });

  listRenderers[selectedId] = renderSelected;

  // render defaults immediately
  renderSelected();
}

function loadPointSettings() {
  try {
    const saved = JSON.parse(localStorage.getItem(POINTS_STORAGE_KEY) || "{}");
    if (saved.eventPoints && typeof saved.eventPoints === "object") {
      eventPoints = { ...eventPoints, ...saved.eventPoints };
    }
    if (typeof saved.coreMultiplier === "number") {
      coreMultiplier = saved.coreMultiplier;
    }
  } catch {
    // ignore invalid local settings
  }
}

function savePointSettings() {
  localStorage.setItem(POINTS_STORAGE_KEY, JSON.stringify({ eventPoints, coreMultiplier }));
}

function syncPointInputs() {
  const ids = {
    rosary: "pointsRosary",
    youth: "pointsYouth",
    holyHour: "pointsHolyHour",
    service: "pointsService"
  };

  Object.entries(ids).forEach(([event, id]) => {
    const input = document.getElementById(id);
    if (input) input.value = String(eventPoints[event]);
  });

  const multiplierInput = document.getElementById("coreMultiplier");
  if (multiplierInput) multiplierInput.value = String(coreMultiplier);
}

function getPointsForAttendee(name) {
  const base = Number(eventPoints[currentMode] || 0);
  const isCore = coreList.some(c => c.name === name);
  return isCore ? Math.round(base * coreMultiplier) : base;
}

/* =========================
   COPY LIST
========================= */
function updateCopyList() {
  const lines = [];

  presentList.forEach(p => {
    const isCore = coreList.some(c => c.name === p.name);
    const points = getPointsForAttendee(p.name);
    lines.push(`${p.name}${isCore ? " (CORE)" : ""} - ${points} pts`);
  });

  document.getElementById("copyList").value = lines.join("\n");
  updateLiveCounter();
  publishCollabState();
}

/* =========================
   LIVE COUNTER
========================= */
function updateLiveCounter() {
  const presentCount = presentList.length;
  const coreCount = coreList.length;
  const tableCount = tables.length;
  const totalPoints = presentList.reduce((sum, person) => sum + getPointsForAttendee(person.name), 0);

  const counter = document.getElementById("liveCounter");
  counter.textContent = `Event: ${EVENT_LABELS[currentMode]}  |  Present: ${presentCount}  |  Core: ${coreCount}  |  Tables: ${tableCount}  |  Total Points: ${totalPoints}`;
}

/* =========================
   CSV EXPORT
========================= */
function exportToCSV() {
  if(!presentList.length){alert("No attendees selected."); return;}
  const now = new Date();
  const month = String(now.getMonth() + 1).padStart(2, "0");
  const day = String(now.getDate()).padStart(2, "0");
  const year = String(now.getFullYear()).slice(-2);
  const filename = `${currentMode}_attendees_${month}_${day}_${year}.csv`;
  const combined = [...presentList];
  const escapeField = value => `"${String(value).replace(/"/g, '""')}"`;
  const tableByAttendee = new Map();
  tables.forEach((table, index) => {
    const tableNumber = index + 1;
    table.forEach(name => tableByAttendee.set(name, tableNumber));
  });

  let csv="Name,Event,Is Core,Points,Table Number,Notes\n";
  combined.forEach(obj=>{
    const tableNumber = tableByAttendee.get(obj.name) || "";
    const isCore = coreList.some(c => c.name === obj.name);
    const points = getPointsForAttendee(obj.name);
    csv += `${escapeField(obj.name)},${escapeField(EVENT_LABELS[currentMode])},${escapeField(isCore ? "Yes" : "No")},${escapeField(points)},${escapeField(tableNumber)},${escapeField(obj.notes||"")}\n`;
  });
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download=filename;
  document.body.appendChild(link); link.click(); document.body.removeChild(link);
  URL.revokeObjectURL(link.href);
}

/* =========================
   TABLES
========================= */
function generateTables() {
  const num=parseInt(document.getElementById("numTables").value);
  if(coreList.length<num){alert("You need at least as many core members as tables."); return;}
  tables=Array.from({length:num},()=>[]);

  function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr;}

  const shuffledCore = shuffle(coreList.map(c => c.name));
  for (let i = 0; i < num; i++) tables[i].push(shuffledCore[i]);

  let remaining = presentList
  .map(p => p.name)
  .filter(n => !coreList.some(c => c.name === n));

  const togetherGroups=document.getElementById("togetherGroups").value.split(/\n+/).map(line=>line.split(",").map(p=>p.trim()));

  togetherGroups.forEach(group=>{
    const presentGroup=group.filter(p=>presentList.some(obj=>obj.name===p));
    if(!presentGroup.length) return;
    const coreInGroup = presentGroup.filter(p =>
      coreList.some(c => c.name === p)
    );
    if(coreInGroup.length){
      const anchor=coreInGroup[0];
      let tableIndex=tables.findIndex(t=>t.includes(anchor));
      presentGroup.forEach(p=>{if(!tables[tableIndex].includes(p)) tables[tableIndex].push(p);});
      remaining=remaining.filter(p=>!presentGroup.includes(p));
    } else {
      let tableIndex=tables.reduce((min,t,idx,arr)=>t.length<arr[min].length?idx:min,0);
      tables[tableIndex].push(...presentGroup);
      remaining=remaining.filter(p=>!presentGroup.includes(p));
    }
  });

  remaining=shuffle(remaining);
  let t=0;
  remaining.forEach(p=>{tables[t].push(p); t=(t+1)%num;});
  renderTables();
  updateLiveCounter();
  publishCollabState();
}

function renderTables() {
  const out=document.getElementById("output");
  out.innerHTML="";
  tables.forEach((tbl,i)=>{
    const div=document.createElement("div"); div.className="table";
    let html=`<h3>Table ${i+1}</h3><ul ondragover="allowDrop(event)" ondrop="drop(event,${i})">`;
    tbl.forEach(p=>html+=`<li draggable="true" ondragstart="drag(event)" data-name="${p}">${p}</li>`);
    html+="</ul>";
    div.innerHTML=html; out.appendChild(div);
  });
}

function drag(ev){ev.dataTransfer.setData("text",ev.target.dataset.name);}
function allowDrop(ev){ev.preventDefault();}
function drop(ev,tableIndex){
  ev.preventDefault();
  const name=ev.dataTransfer.getData("text");
  tables.forEach(t=>{const idx=t.indexOf(name); if(idx!==-1) t.splice(idx,1);});
  tables[tableIndex].push(name); renderTables(); updateLiveCounter(); publishCollabState();
}

/* =========================
   MODE
========================= */
function setMode(mode){
  currentMode=mode;
  document.getElementById("rosaryBtn").classList.toggle("active-mode",mode==="rosary");
  document.getElementById("youthBtn").classList.toggle("active-mode",mode==="youth");
  document.getElementById("holyHourBtn").classList.toggle("active-mode",mode==="holyHour");
  document.getElementById("serviceBtn").classList.toggle("active-mode",mode==="service");
  document.getElementById("youthFeatures").classList.toggle("hidden",mode!=="youth");
  updateCopyList();
  publishCollabState();
}

setupAutocomplete(
  "presentInput",
  "presentSuggestions",
  "presentSelected",
  allAttendees,
  presentList,
  true
);

setupAutocomplete(
  "coreInput",
  "coreSuggestions",
  "coreSelected",
  allAttendees,
  coreList,
  true
);

function toggleDarkMode() {
  document.body.classList.toggle("dark-mode");
  const button = document.getElementById("darkModeBtn");
  const isDark = document.body.classList.contains("dark-mode");
  button.classList.toggle("dark-on", isDark);
  button.setAttribute("aria-pressed", isDark ? "true" : "false");
  button.textContent = isDark ? "Turn off Dark Mode" : "Turn on Dark Mode";
  publishCollabState();
}


const connectSessionBtn = document.getElementById("connectSessionBtn");
if (connectSessionBtn) {
  connectSessionBtn.addEventListener("click", connectCollabSession);
}

const sessionCodeInput = document.getElementById("sessionCodeInput");
if (sessionCodeInput) {
  sessionCodeInput.addEventListener("keydown", event => {
    if (event.key === "Enter") {
      event.preventDefault();
      connectCollabSession();
    }
  });
}

const sessionKeyInput = document.getElementById("sessionKeyInput");
if (sessionKeyInput) {
  sessionKeyInput.addEventListener("keydown", event => {
    if (event.key === "Enter") {
      event.preventDefault();
      connectCollabSession();
    }
  });
}

const collabDisplayNameInput = document.getElementById("collabDisplayName");
if (collabDisplayNameInput) {
  collabDisplayNameInput.addEventListener("input", () => {
    if (collabSessionCode) {
      localStorage.setItem(COLLAB_NAME_STORAGE_KEY, getCollabDisplayName());
      setAwarenessState();
      refreshPresenceCard();
    }
  });
}

window.addEventListener("storage", event => {
  if (collabStorageKey && event.key === collabStorageKey && event.newValue) {
    queueApplyIncomingState(event.newValue);
  }

});

const togetherGroupsInput = document.getElementById("togetherGroups");
if (togetherGroupsInput) {
  togetherGroupsInput.addEventListener("input", publishCollabState);
}

const numTablesInput = document.getElementById("numTables");
if (numTablesInput) {
  numTablesInput.addEventListener("input", publishCollabState);
}

const pointInputMap = {
  pointsRosary: "rosary",
  pointsYouth: "youth",
  pointsHolyHour: "holyHour",
  pointsService: "service"
};

Object.entries(pointInputMap).forEach(([id, eventName]) => {
  const input = document.getElementById(id);
  if (!input) return;
  input.addEventListener("input", () => {
    eventPoints[eventName] = Math.max(0, Number(input.value) || 0);
    savePointSettings();
    updateCopyList();
    publishCollabState();
  });
});

const coreMultiplierInput = document.getElementById("coreMultiplier");
if (coreMultiplierInput) {
  coreMultiplierInput.addEventListener("input", () => {
    coreMultiplier = Math.max(1, Number(coreMultiplierInput.value) || 1);
    savePointSettings();
    updateCopyList();
    publishCollabState();
  });
}

const savedCollabName = localStorage.getItem(COLLAB_NAME_STORAGE_KEY);
if (savedCollabName) {
  const collabNameInput = document.getElementById("collabDisplayName");
  if (collabNameInput) collabNameInput.value = savedCollabName;
}

loadPointSettings();
syncPointInputs();
updateCopyList();
refreshPresenceCard();

window.addEventListener("beforeunload", () => stopFirebaseSubscription());


</script>
</body>
</html>
